<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bingo Admin</title>
<style>
#boards{ display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;}
.player-board{border:1px solid #333; padding:5px;}
.board-grid{display:grid; grid-template-columns:repeat(5,40px); gap:3px;}
.cell{width:40px; height:40px; display:flex; justify-content:center; align-items:center; border:1px solid #333; font-size:14px;}
.marked{background-color:green; color:white;}
.bingo{border:2px solid red;}
    .hidden {
      display: none !important;
    }
    .modal-bg{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center;z-index:1200;padding:20px}
    .modal{width:820px;max-width:100%;background:var(--card);padding:20px;border-radius:12px;}
</style>
</head>
<body>
<h2>Bingo Admin</h2>
<label>Password: <input type="password" id="pass"></label>
<button onclick="startGame()">Start Game</button>
<button onclick="endGame()">End Game</button>
<button onclick="callNumber()">Call Number</button>
<button onclick="requestBoards()">Refresh Boards</button>

<div id="lastNumber"></div>
<div id="boards"></div>
<div id="error" class="modal-bg hidden">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>AN ERROR OCCURED!</h3>
      <p id="errortxt">Error: </p>
      <br>
      <button onclick="closeError()">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("https://server.ctksystem.com")
let allBoards = []

function getPass(){ return document.getElementById("pass").value }

function startGame(){
  fetch("https://server.ctksystem.com/start", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({password:getPass()})
  }).then(r=>r.json()).then(r=>console.log(r))
}

function endGame(){
  fetch("https://server.ctksystem.com/end", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({password:getPass()})
  }).then(r=>r.json()).then(r=>console.log(r))
}

function callNumber(){
  fetch("https://server.ctksystem.com/call", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({password:getPass()})
  }).then(r=>r.json()).then(r=>{
    if(r.number) document.getElementById("lastNumber").textContent="Last called: "+r.number
  })
}

function requestBoards(){
  socket.emit("request_boards", getPass())
}

function kickPlayer(socketId){
  if (!confirm("Kick this player?")) return

  socket.emit("kick_player", {
    password: getPass(),
    socketId
  })
}

function errorTrigger(error) {
  document.getElementById("errortxt").innerText = "Error: " + error
  document.getElementById("error").classList.remove("hidden")
}

function closeError() {
  document.getElementById("error").classList.add("hidden")
}

// ================= SOCKET EVENTS =================
socket.on("all_boards", boards=>{
  allBoards = boards
  renderBoards()
})

socket.on("player_bingo", data=>{
  alert("Player "+data.name+" got BINGO!")
  requestBoards()
})

socket.on("game_ended", ()=>{
  alert("Game ended!")
  requestBoards()
})

// ================= RENDER =================
function renderBoards(){
  const div = document.getElementById("boards")
  div.innerHTML=""
  allBoards.forEach(p=>{
    const pb = document.createElement("div")
    pb.className="player-board"
    if(p.hasBingo) pb.classList.add("bingo")
    const title = document.createElement("div")
    title.innerHTML = `
      <strong>${p.name}</strong>
      <button onclick="kickPlayer('${p.socketId}')">Kick</button>
    `
    pb.appendChild(title)

    const grid = document.createElement("div")
    grid.className="board-grid"
    p.board.forEach((val,i)=>{
      const cell = document.createElement("div")
      cell.className="cell"
      cell.textContent=val
      if(p.marks.includes(i) || val==="FREE") cell.classList.add("marked")
      grid.appendChild(cell)
    })
    pb.appendChild(grid)
    div.appendChild(pb)
  })
}
</script>
</body>
</html>
